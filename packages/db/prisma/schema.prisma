generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MenuType {
  TAKEAWAY
  DINEIN
}

enum OrderStatus {
  CREATED
  PREPARING
  READY
  DELIVERED
  CANCELLED
  NOSHOW
}

enum RestaurantUserRole {
  OWNER
  MANAGER
  STAFF
}

enum SettlementMode {
  WEEKLY_CALENDAR
  ROLLING_7D
  CUSTOM_RANGE
}

enum SettlementStatus {
  DRAFT
  CONFIRMED
  PAID
  DISPUTED
}

model Restaurant {
  id            String   @id @default(cuid())
  name          String
  slug          String?  @unique
  address       String
  phone         String?
  lat           Float
  lng           Float
  zoneTag       String

  commissionBps Int      @default(0)
  contactPeople String?

  logoUrl       String?
  coverUrl      String?

  settlementMode     SettlementMode @default(WEEKLY_CALENDAR)
  settlementWeekday  Int            @default(1)
  settlementTimezone String         @default("Europe/Madrid")
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  menus         Menu[]
  users         RestaurantUser[]
  settlements   Settlement[]

  @@index([isActive])
  @@index([zoneTag])
}

model RestaurantUser {
  id           String             @id @default(cuid())
  restaurantId String
  email        String             @unique
  passwordHash String
  role         RestaurantUserRole @default(STAFF)
  isActive     Boolean            @default(true)

  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  restaurant   Restaurant         @relation(fields: [restaurantId], references: [id])
  deliveredOrders Order[]         @relation("DeliveredBy")

  @@index([restaurantId])
  @@index([isActive])
}

model Menu {
  id                  String   @id @default(cuid())
  restaurantId        String
  type                MenuType
  title               String
  description         String
  priceCents          Int
  currency            String
  quantity            Int
  availableFrom       DateTime
  availableTo         DateTime
  expiresAt           DateTime
  allowTimeAdjustment Boolean  @default(false)
  imageUrl            String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  restaurant          Restaurant @relation(fields: [restaurantId], references: [id])
  orders              Order[]

  @@index([restaurantId])
  @@index([expiresAt])
}

model Order {
  id                      String      @id @default(cuid())
  menuId                  String
  status                  OrderStatus @default(CREATED)
  customerName            String
  customerEmail           String
  code                    String

  totalCents              Int?
  commissionBpsAtPurchase Int?
  platformFeeCents        Int?

  customerId              String?
  settlementId            String?

  deliveredAt             DateTime?
  deliveredByUserId       String?

  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  menu                    Menu @relation(fields: [menuId], references: [id])
  deliveredBy             RestaurantUser? @relation("DeliveredBy", fields: [deliveredByUserId], references: [id])
  customer                Customer? @relation(fields: [customerId], references: [id])
  settlement              Settlement? @relation(fields: [settlementId], references: [id])

  @@index([menuId])
  @@index([status])
  @@index([code])
  @@index([createdAt])
  @@index([deliveredAt])
  @@index([settlementId])
}

model Customer {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  phone        String?
  address      String?
  city         String?
  postalCode   String?
  lat          Float?
  lng          Float?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders       Order[]
}

model AdminUser {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Settlement {
  id                   String           @id @default(cuid())
  restaurantId         String
  periodStart          DateTime
  periodEnd            DateTime
  status               SettlementStatus @default(DRAFT)

  totalOrdersCents     Int              @default(0)
  totalOrders          Int              @default(0)
  platformFeeCents     Int              @default(0)
  netToRestaurantCents Int              @default(0)
  commissionBps        Int              @default(0)

  notes                String?
  confirmedAt          DateTime?
  confirmedBy          String?
  paidAt               DateTime?
  paidBy               String?

  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  restaurant           Restaurant       @relation(fields: [restaurantId], references: [id])
  orders               Order[]

  @@index([restaurantId])
  @@index([status])
  @@index([periodStart])
}
